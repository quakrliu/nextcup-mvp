<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextCup ç¦®ç‰©å…Œæ›</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; background-color: #f8f9fa; }
        .card { background: white; border-radius: 15px; padding: 30px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; }
        h1 { color: #333; font-size: 24px; margin-bottom: 10px; }
        #timer { font-size: 48px; color: #ff4b4b; font-weight: bold; margin: 20px 0; font-family: monospace; display:none; }
        .btn { display:none; width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn:active { background: #05b34c; }
        .btn:disabled { background: #ccc; }
        p { color: #666; }
    </style>
</head>
<body>

    <div class="card">
        <h1 id="status-text">ğŸ”„ é€£ç·šç¢ºèªä¸­...</h1>
        <p id="sub-text">æ­£åœ¨æŸ¥è©¢ç¦®ç‰©ç‹€æ…‹</p>
        
        <div id="timer">02:00:00</div>
        
        <button id="btn-redeem" class="btn" onclick="redeemGift()">åº—å“¡æ ¸éŠ·è«‹é»æ­¤</button>
    </div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        // ã€å·²å¹«æ‚¨å¡«å…¥æ‚¨çš„è³‡æ–™ã€‘
        
        const AIRTABLE_TOKEN = 'patWFQeH1vf1ga28J.5d619ffcd3e5e85346fef6d8fd1ad308a5e4e951e630ea7392dff7fe4274662a'; 
        const BASE_ID = 'appg9LVwwgUcig6Ze';          
        const TABLE_ID = 'tbl3Y1Jq4VmlcjQgI';         
        const LIFF_ID = '2008760789-8sSFZSxG';        

        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let recordId = null; 

        async function main() {
            // åˆå§‹åŒ– LIFF
            try {
                await liff.init({ liffId: LIFF_ID });
            } catch (err) {
                console.error("LIFF Init Error", err);
            }
            
            // æŠ“å–ç¶²å€ä¸Šçš„ç¦®ç‰© ID
            const urlParams = new URLSearchParams(window.location.search);
            const giftId = urlParams.get('id');

            if (!giftId) {
                showError("ç„¡æ•ˆçš„é€£çµ", "æ‰¾ä¸åˆ°ç¦®ç‰©ç·¨è™Ÿ (No ID)");
                return;
            }

            // å» Airtable æŸ¥ç‹€æ…‹
            await checkStatus(giftId);
        }

        async function checkStatus(giftId) {
            const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}?filterByFormula={Gift_ID}='${giftId}'`;
            
            try {
                const response = await fetch(url, {
                    headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
                });
                const data = await response.json();

                if (!data.records || data.records.length === 0) {
                    showError("æŸ¥ç„¡æ­¤åˆ¸", "é€£çµå¯èƒ½éŒ¯èª¤ï¼Œè«‹ç¢ºèª ID");
                    return;
                }

                const record = data.records[0];
                recordId = record.id; 
                const status = record.fields.Status;

                if (status === 'Redeemed') {
                    showError("âŒ æ­¤ç¦®ç‰©å·²å¤±æ•ˆ", "é€™æ¯å’–å•¡å·²ç¶“è¢«é ˜éå›‰ï¼");
                } else {
                    showActive();
                }
            } catch (e) {
                console.error(e);
                showError("é€£ç·šéŒ¯èª¤", "ç„¡æ³•é€£æ¥è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ Token èˆ‡ ID");
            }
        }

        function showActive() {
            document.getElementById('status-text').innerText = "â˜•ï¸ æ‚¨æœ‰ä¸€æ¯å’–å•¡å¾…é ˜å–";
            document.getElementById('sub-text').innerText = "ä¾†è‡ªå¥½å‹çš„å¿ƒæ„";
            document.getElementById('timer').style.display = "block";
            document.getElementById('btn-redeem').style.display = "block";
            startTimer();
        }

        function showError(title, msg) {
            document.getElementById('status-text').innerText = title;
            document.getElementById('status-text').style.color = "#888";
            document.getElementById('sub-text').innerText = msg;
            document.getElementById('timer').style.display = "none";
            document.getElementById('btn-redeem').style.display = "none";
        }

        async function redeemGift() {
            let code = prompt("è«‹åº—å“¡è¼¸å…¥æ ¸éŠ·å¯†ç¢¼ï¼š");
            if (code !== "8888") {
                alert("âŒ å¯†ç¢¼éŒ¯èª¤");
                return;
            } 
            
            const btn = document.getElementById('btn-redeem');
            btn.innerText = "é€£ç·šå¯«å…¥ä¸­...";
            btn.disabled = true;

            // æº–å‚™è¦æ›´æ–°çš„è³‡æ–™ (åªæ›´æ–° Statuså’Œæ™‚é–“)
            const data = {
                fields: {
                    Status: 'Redeemed',
                    Redeemed_Time: new Date().toISOString() // ğŸ‘ˆ åŠ ä¸Šé€™ä¸€è¡Œ
                   
                }
            };

            const updateUrl = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}/${recordId}`;
            
            try {
                const response = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("âœ… æ ¸éŠ·æˆåŠŸï¼ç‹€æ…‹å·²æ›´æ–°ã€‚");
                    location.reload(); 
                } else {
                    const err = await response.json();
                    alert("âš ï¸ æ ¸éŠ·å¤±æ•—ï¼éŒ¯èª¤åŸå› ï¼š\n" + err.error.type + ": " + err.error.message);
                    btn.innerText = "åº—å“¡æ ¸éŠ·è«‹é»æ­¤";
                    btn.disabled = false;
                }
            } catch (e) {
                alert("âŒ é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼š" + e);
                btn.innerText = "åº—å“¡æ ¸éŠ·è«‹é»æ­¤";
                btn.disabled = false;
            }
        }
        
        function startTimer() {
             let timer = 7200;
             setInterval(() => {
                 let h = Math.floor(timer/3600).toString().padStart(2,'0');
                 let m = Math.floor((timer%3600)/60).toString().padStart(2,'0');
                 let s = (timer%60).toString().padStart(2,'0');
                 document.getElementById('timer').innerText = `${h}:${m}:${s}`;
                 timer--;
             }, 1000);
        }

        main();
    </script>
</body>
</html>
