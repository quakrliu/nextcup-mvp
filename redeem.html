<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextCup ç¦®ç‰©å…Œæ›</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; background-color: #f8f9fa; }
        .card { background: white; border-radius: 15px; padding: 40px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto; }
        h1 { color: #333; font-size: 26px; margin-bottom: 10px; font-weight: 800; }
        p { color: #666; line-height: 1.6; }
        
        /* å€’æ•¸è¨ˆæ™‚å™¨ */
        #timer { font-size: 48px; color: #ff4b4b; font-weight: bold; margin: 25px 0; font-family: monospace; display:none; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { display:none; width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); background: #05b34c; }
        .btn:disabled { background: #ccc; pointer-events: none; }
        
        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loading { color: #888; font-size: 14px; margin-top: 20px; }
        
        /* éŒ¯èª¤è¨Šæ¯ç´…å­— */
        .error-text { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h1 id="status-text">ğŸ”„ èº«åˆ†ç¢ºèªä¸­...</h1>
        <p id="sub-text">æ­£åœ¨æŸ¥è©¢æ‚¨çš„é ˜å–è³‡æ ¼</p>
        
        <div id="timer">02:00:00</div>
        
        <button id="btn-redeem" class="btn" onclick="redeemGift()">åº—å“¡æ ¸éŠ·è«‹é»æ­¤</button>
    </div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        // ã€è¨­å®šå€ã€‘ (å·²ä¿ç•™æ‚¨çš„è¨­å®š)
        
        const AIRTABLE_TOKEN = 'patWFQeH1vf1ga28J.5d619ffcd3e5e85346fef6d8fd1ad308a5e4e951e630ea7392dff7fe4274662a'; 
        const BASE_ID = 'appg9LVwwgUcig6Ze';          
        const TABLE_ID = 'tbl3Y1Jq4VmlcjQgI';         
        const LIFF_ID = '2008760789-8sSFZSxG';        

        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let recordId = null; 
        let currentUserId = null; // ç”¨ä¾†å­˜å®¢äººçš„ ID

        async function main() {
            // 1. åˆå§‹åŒ– LIFF ä¸¦ç™»å…¥
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login(); // æ²’ç™»å…¥å°±å¼·åˆ¶ç™»å…¥ï¼Œæ‰èƒ½çŸ¥é“æ˜¯èª°é ˜çš„
                    return;
                }
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
            } catch (err) {
                console.error("LIFF Init Error", err);
                showError("ç³»çµ±éŒ¯èª¤", "ç„¡æ³•è­˜åˆ¥ä½¿ç”¨è€…èº«åˆ†");
                return;
            }
            
            // 2. æŠ“å–ç¶²å€ä¸Šçš„ç¦®ç‰© ID
            const urlParams = new URLSearchParams(window.location.search);
            const giftId = urlParams.get('id');

            if (!giftId) {
                showError("ç„¡æ•ˆçš„é€£çµ", "æ‰¾ä¸åˆ°ç¦®ç‰©ç·¨è™Ÿ (No ID)");
                return;
            }

            // 3. é›™é‡æª¢æŸ¥ï¼š(A) æª¢æŸ¥é€™å¼µåˆ¸çš„ç‹€æ…‹ (B) æª¢æŸ¥é€™å€‹äººæ˜¯å¦é ˜éåˆ¥å¼µ
            await checkQualification(giftId, currentUserId);
        }

        async function checkQualification(giftId, userId) {
            // æ­¥é©Ÿ A: æª¢æŸ¥äºº (æ˜¯å¦å·²ç¶“åœ¨ Airtable ç•™éåï¼Œä¸”ç‹€æ…‹æ˜¯ Redeemed)
            // æœå°‹æ¢ä»¶ï¼šReceiver_ID æ˜¯é€™å€‹äººï¼Œè€Œä¸” Status æ˜¯ Redeemed
            const checkUserUrl = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}?filterByFormula=AND({Receiver_ID}='${userId}', {Status}='Redeemed')`;
            
            try {
                const userRes = await fetch(checkUserUrl, { headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` } });
                const userData = await userRes.json();

                if (userData.records.length > 0) {
                    // æŠ“åˆ°äº†ï¼é€™å€‹äººå·²ç¶“é ˜éå’–å•¡äº†
                    showError("ğŸš« æ‚¨å·²ç¶“é ˜éå›‰ï¼", "æ¯äººé™é ˜ä¸€æ¬¡å…è²»å’–å•¡ã€‚\næŠŠæ©Ÿæœƒè®“çµ¦å…¶ä»–æ–°æœ‹å‹å§ï¼");
                    return;
                }

                // æ­¥é©Ÿ B: æª¢æŸ¥åˆ¸ (å¦‚æœäººæ²’å•é¡Œï¼Œæ‰æª¢æŸ¥é€™å¼µåˆ¸æ˜¯å¦æœ‰æ•ˆ)
                await checkGiftStatus(giftId);

            } catch (e) {
                console.error(e);
                showError("é€£ç·šéŒ¯èª¤", "ç„¡æ³•æŸ¥è©¢è³‡æ ¼");
            }
        }

        async function checkGiftStatus(giftId) {
            const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}?filterByFormula={Gift_ID}='${giftId}'`;
            
            try {
                const response = await fetch(url, {
                    headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
                });
                const data = await response.json();

                if (!data.records || data.records.length === 0) {
                    showError("æŸ¥ç„¡æ­¤åˆ¸", "é€£çµå¯èƒ½éŒ¯èª¤ï¼Œè«‹ç¢ºèª ID");
                    return;
                }

                const record = data.records[0];
                recordId = record.id; 
                const status = record.fields.Status;

                if (status === 'Redeemed') {
                    showError("âŒ æ­¤ç¦®ç‰©å·²å¤±æ•ˆ", "é€™æ¯å’–å•¡å·²ç¶“è¢«é ˜éå›‰ï¼");
                } else {
                    // å…¨éƒ¨é€šéï¼é¡¯ç¤ºé ˜å–ç•«é¢
                    showActive();
                }
            } catch (e) {
                showError("é€£ç·šéŒ¯èª¤", "ç„¡æ³•é€£æ¥è³‡æ–™åº«");
            }
        }

        function showActive() {
            document.getElementById('status-text').innerText = "â˜•ï¸ æ‚¨æœ‰ä¸€æ¯å’–å•¡å¾…é ˜å–";
            document.getElementById('sub-text').innerText = "ä¾†è‡ªå¥½å‹çš„å¿ƒæ„";
            document.getElementById('timer').style.display = "block";
            document.getElementById('btn-redeem').style.display = "block";
            startTimer();
        }

        function showError(title, msg) {
            document.getElementById('status-text').innerText = title;
            document.getElementById('status-text').className = "error-text"; // è®Šç´…è‰²
            document.getElementById('sub-text').innerText = msg;
            document.getElementById('timer').style.display = "none";
            document.getElementById('btn-redeem').style.display = "none";
        }

        async function redeemGift() {
            let code = prompt("è«‹åº—å“¡è¼¸å…¥æ ¸éŠ·å¯†ç¢¼ï¼š");
            if (code !== "8888") {
                alert("âŒ å¯†ç¢¼éŒ¯èª¤");
                return;
            } 
            
            const btn = document.getElementById('btn-redeem');
            btn.innerText = "æ­£åœ¨æ ¸éŠ·...";
            btn.disabled = true;

            // æº–å‚™è¦æ›´æ–°çš„è³‡æ–™
            // é€™æ¬¡æˆ‘å€‘è¦æŠŠ Receiver_ID (é ˜å–äºº) ä¹Ÿå¯«é€²å»ï¼
            const data = {
                fields: {
                    Status: 'Redeemed',
                    Redeemed_Time: new Date().toISOString(), // å¯«å…¥æ™‚é–“
                    Receiver_ID: currentUserId               // ğŸ‘ˆ å¯«å…¥é ˜å–äºº ID
                }
            };

            const updateUrl = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}/${recordId}`;
            
            try {
                const response = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("âœ… æ ¸éŠ·æˆåŠŸï¼\näº«å—æ‚¨çš„å’–å•¡å§ï¼");
                    location.reload(); 
                } else {
                    const err = await response.json();
                    alert("âš ï¸ æ ¸éŠ·å¤±æ•—ï¼š" + err.error.message);
                    btn.innerText = "åº—å“¡æ ¸éŠ·è«‹é»æ­¤";
                    btn.disabled = false;
                }
            } catch (e) {
                alert("âŒ é€£ç·šéŒ¯èª¤");
                btn.disabled = false;
            }
        }
        
        function startTimer() {
             let timer = 7200;
             setInterval(() => {
                 let h = Math.floor(timer/3600).toString().padStart(2,'0');
                 let m = Math.floor((timer%3600)/60).toString().padStart(2,'0');
                 let s = (timer%60).toString().padStart(2,'0');
                 document.getElementById('timer').innerText = `${h}:${m}:${s}`;
                 timer--;
             }, 1000);
        }

        main();
    </script>
</body>
</html>
