<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextCup ç¦®ç‰©è£½ä½œ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* æ•´é«”èƒŒæ™¯ï¼šæº«æš–çš„æ¼¸å±¤è‰² */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’é–‹å¯¬åº¦ */
        }

        /* å¡ç‰‡è¨­è¨ˆ */
        .card {
            background: white;
            border-radius: 24px;
            padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        /* é ‚éƒ¨æ’åœ–å€åŸŸ */
        .hero-illustration {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        /* æ¨™é¡Œè¨­è¨ˆ */
        h1 {
            color: #d35400;
            font-size: 28px;
            font-weight: 800;
            margin: 0 0 15px 0;
            letter-spacing: -0.5px;
        }

        /* æè¿°æ–‡å­— */
        p {
            color: #666;
            line-height: 1.8;
            font-size: 16px;
            margin-bottom: 30px;
        }
        .highlight {
            color: #e67e22;
            font-weight: bold;
        }

        /* --- æŒ‰éˆ•è¨­è¨ˆé‡é»ä¿®æ”¹ --- */
        .btn {
            display: none; /* é è¨­éš±è— */
            width: auto; /* ä¸å†å¼·åˆ¶ 100% */
            margin: 20px auto 0; /* ä¸Šæ–¹ç•™ç™½ï¼Œå·¦å³ç½®ä¸­ */
            padding: 15px 30px; /* èª¿æ•´å…§è·ï¼Œè®“æŒ‰éˆ•çœ‹èµ·ä¾†æ›´ç´®å¯¦ */
            
            /* LINE å®˜æ–¹ç¶ è‰²æ¼¸å±¤ */
            background: linear-gradient(to right, #06c755, #02b902);
            color: white;
            border: none;
            border-radius: 50px; /* è®Šæˆå…¨åœ“è§’è¨­è¨ˆ */
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            
            /* ç«‹é«”é™°å½± */
            box-shadow: 0 4px 15px rgba(6, 199, 85, 0.4);
            transition: all 0.2s ease;
            
            /* è®“åœ–ç¤ºå’Œæ–‡å­—å±…ä¸­å°é½Š */
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

        /* æŒ‰éˆ•åœ–ç¤ºé–“è· */
        .btn i {
            margin-right: 10px;
            font-size: 24px;
        }

        /* æŒ‰éˆ•æŒ‰ä¸‹æ•ˆæœ */
        .btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(6, 199, 85, 0.3);
        }

        /* éŒ¯èª¤ç‹€æ…‹æŒ‰éˆ• */
        .btn.disabled {
            background: #bdc3c7;
            box-shadow: none;
            pointer-events: none;
        }
        .error-title { color: #e74c3c; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .loading-state { opacity: 0.7; }
    </style>
</head>
<body>

    <div class="card">
        <div class="hero-illustration" id="hero-icon">ğŸ</div>
        
        <h1 id="title" class="loading-state">æ­£åœ¨ç¢ºèªè³‡æ ¼...</h1>
        <p id="desc">ç³»çµ±æ­£åœ¨æŸ¥è©¢æ‚¨çš„é€ç¦®ç´€éŒ„<br>è«‹ç¨å€™...</p>
        
        <a id="btn-share" class="btn" href="#">
            <i class="fab fa-line"></i> <span>LINE çµ¦æœ‹å‹</span>
        </a>
    </div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        // ã€è¨­å®šå€ã€‘ (å·²ä¿ç•™æ‚¨çš„è¨­å®š)
        
        const AIRTABLE_TOKEN = 'patWFQeH1vf1ga28J.5d619ffcd3e5e85346fef6d8fd1ad308a5e4e951e630ea7392dff7fe4274662a'; 
        const BASE_ID = 'appg9LVwwgUcig6Ze';          
        const TABLE_ID = 'tbl3Y1Jq4VmlcjQgI';         
        const LIFF_ID = '2008760789-8sSFZSxG'; 
        const MY_DOMAIN = 'nextcup-mvp.vercel.app'; 

        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login(); return;
                }
            } catch (err) {
                console.error("LIFF Error", err); alert("LIFF åˆå§‹åŒ–å¤±æ•—"); return;
            }

            const profile = await liff.getProfile();
            const userId = profile.userId;

            const hasSent = await checkHistory(userId);
            
            document.getElementById('title').classList.remove('loading-state');

            if (hasSent) {
                showError("ğŸš« æ‚¨å·²ç¶“é€éç¦®ç‰©å›‰ï¼", "æ¯äººé™é€ä¸€æ¬¡ã€‚\næŠŠæ©Ÿæœƒè®“çµ¦å…¶ä»–äººå§ï¼");
            } else {
                document.getElementById('title').innerText = "ğŸ æ­£åœ¨åŒ…è£ç¦®ç‰©...";
                createGift(userId);
            }
        }

        async function checkHistory(userId) {
            const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}?filterByFormula={Sender_ID}='${userId}'`;
            try {
                const response = await fetch(url, { headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` } });
                const data = await response.json();
                return data.records.length > 0;
            } catch (e) { console.error(e); return false; }
        }

        async function createGift(userId) {
            const newGiftId = 'Gift_' + Date.now();
            const data = { fields: { Gift_ID: newGiftId, Status: 'Active', Sender_ID: userId } };
            const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AIRTABLE_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) { showSuccess(newGiftId); } else { alert("è£½ä½œå¤±æ•—ï¼Œè«‹é‡è©¦"); }
            } catch (error) { console.error(error); alert("é€£ç·šéŒ¯èª¤"); }
        }

        function showSuccess(giftId) {
            document.getElementById('hero-icon').innerText = "ğŸ‰";
            document.getElementById('title').innerText = "ç¦®ç‰©åŒ…è£å®Œæˆï¼";
            document.getElementById('desc').innerHTML = "é€™æ˜¯æ‚¨<span class='highlight'>å”¯ä¸€çš„é€ç¦®æ©Ÿæœƒ</span><br>è¶•å¿«å‚³çµ¦æœ‹å‹å§ï¼";
            
            const redeemLink = `https://${MY_DOMAIN}/redeem.html?id=${giftId}`;
            const shareText = `å˜¿ï¼é€™å®¶å’–å•¡ä¸éŒ¯ï¼Œæˆ‘è«‹ä½ å–ä¸€æ¯ï¼é»é€™è£¡é ˜å–ï¼š ${redeemLink}`;
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`;
            
            const btn = document.getElementById('btn-share');
            btn.style.display = 'flex'; // é¡¯ç¤ºæŒ‰éˆ•
            btn.href = lineUrl;
        }

        function showError(title, msg) {
            document.getElementById('hero-icon').innerText = "ğŸš·";
            document.getElementById('title').innerText = title;
            document.getElementById('title').className = "error-title";
            document.getElementById('desc').innerText = msg;
            
            const btn = document.getElementById('btn-share');
            btn.style.display = 'flex';
            btn.innerHTML = "<span>é—œé–‰è¦–çª—</span>";
            btn.className = "btn disabled";
            btn.onclick = (e) => { e.preventDefault(); liff.closeWindow(); };
        }

        main();
    </script>
</body>
</html>
