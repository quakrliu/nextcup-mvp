<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextCup è£½ä½œç¦®ç‰©</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; background-color: #fff8e1; }
        .card { background: white; border-radius: 15px; padding: 30px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 40px; }
        h1 { color: #d35400; font-size: 24px; margin-bottom: 10px; }
        p { color: #666; line-height: 1.6; }
        .btn { display:none; width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; text-decoration: none; margin-top: 20px; }
        .btn.disabled { background-color: #ccc; pointer-events: none; }
        .error { color: #ff4b4b; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h1 id="title">ğŸ æ­£åœ¨ç¢ºèªè³‡æ ¼...</h1>
        <p id="desc">ç³»çµ±æ­£åœ¨æŸ¥è©¢æ‚¨çš„é€ç¦®ç´€éŒ„<br>è«‹ç¨å€™...</p>
        
        <a id="btn-share" class="btn" href="#">LINE çµ¦æœ‹å‹</a>
    </div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        // ã€è¨­å®šå€ã€‘
        
        const AIRTABLE_TOKEN = 'patWFQeH1vf1ga28J.5d619ffcd3e5e85346fef6d8fd1ad308a5e4e951e630ea7392dff7fe4274662a'; 
        const BASE_ID = 'appg9LVwwgUcig6Ze';          
        const TABLE_ID = 'tbl3Y1Jq4VmlcjQgI';         
        const LIFF_ID = '2008760789-8sSFZSxG'; // æ‚¨çš„ LIFF ID
        
        // âš ï¸ è«‹ç¢ºèªæ‚¨çš„çŸ­ç¶²å€ (ä¸å« https://)
        const MY_DOMAIN = 'nextcup-mvp.vercel.app'; 

        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        async function main() {
            // 1. åˆå§‹åŒ– LIFF ä¸¦ç™»å…¥ (ç‚ºäº†æ‹¿åˆ° User ID)
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login(); // æ²’ç™»å…¥å°±å¼·åˆ¶ç™»å…¥
                    return;
                }
            } catch (err) {
                console.error("LIFF Error", err);
                alert("LIFF åˆå§‹åŒ–å¤±æ•—");
                return;
            }

            // 2. å–å¾—ä½¿ç”¨è€… ID
            const profile = await liff.getProfile();
            const userId = profile.userId;

            // 3. æª¢æŸ¥æ˜¯å¦å·²ç¶“é€é
            const hasSent = await checkHistory(userId);
            
            if (hasSent) {
                showError("ğŸš« æ‚¨å·²ç¶“é€éç¦®ç‰©å›‰ï¼", "æ¯äººé™é€ä¸€æ¬¡ã€‚\næŠŠæ©Ÿæœƒè®“çµ¦å…¶ä»–äººå§ï¼");
            } else {
                // 4. æ²’é€é -> é–‹å§‹è£½ä½œ
                document.getElementById('title').innerText = "ğŸ æ­£åœ¨åŒ…è£ç¦®ç‰©...";
                createGift(userId);
            }
        }

        async function checkHistory(userId) {
            // å» Airtable æœå°‹æœ‰æ²’æœ‰é€™å€‹ Sender_ID
            const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}?filterByFormula={Sender_ID}='${userId}'`;
            
            try {
                const response = await fetch(url, {
                    headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
                });
                const data = await response.json();
                // å¦‚æœæ‰¾åˆ°å¤§æ–¼ 0 ç­†è³‡æ–™ï¼Œä»£è¡¨é€éäº†
                return data.records.length > 0;
            } catch (e) {
                console.error(e);
                return false; // é€£ç·šå¤±æ•—é è¨­ç•¶ä½œæ²’é€éï¼Œæˆ–å¯æ”¹æˆé˜»æ“‹
            }
        }

        async function createGift(userId) {
            const newGiftId = 'Gift_' + Date.now();

            const data = {
                fields: {
                    Gift_ID: newGiftId,
                    Status: 'Active',
                    Sender_ID: userId  // ğŸ‘ˆ é€™æ¬¡æœƒæŠŠæ˜¯èª°é€çš„è¨˜ä¸‹ä¾†ï¼
                }
            };

            const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showSuccess(newGiftId);
                } else {
                    alert("è£½ä½œå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢è©¦è©¦çœ‹");
                }
            } catch (error) {
                console.error(error);
                alert("é€£ç·šéŒ¯èª¤");
            }
        }

        function showSuccess(giftId) {
            document.getElementById('title').innerText = "ğŸ‰ ç¦®ç‰©åŒ…è£å®Œæˆï¼";
            document.getElementById('desc').innerText = "é€™æ˜¯æ‚¨å”¯ä¸€çš„é€ç¦®æ©Ÿæœƒ\nè¶•å¿«å‚³çµ¦æœ‹å‹å§ï¼";
            
            const redeemLink = `https://${MY_DOMAIN}/redeem.html?id=${giftId}`;
            const shareText = `å˜¿ï¼é€™å®¶å’–å•¡ä¸éŒ¯ï¼Œæˆ‘è«‹ä½ å–ä¸€æ¯ï¼é»é€™è£¡é ˜å–ï¼š ${redeemLink}`;
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`;
            
            const btn = document.getElementById('btn-share');
            btn.style.display = 'block';
            btn.href = lineUrl;
        }

        function showError(title, msg) {
            document.getElementById('title').innerText = title;
            document.getElementById('title').className = "error";
            document.getElementById('desc').innerText = msg;
            
            const btn = document.getElementById('btn-share');
            btn.style.display = 'block';
            btn.innerText = "é—œé–‰è¦–çª—";
            btn.className = "btn disabled"; // è®“æŒ‰éˆ•è®Šç°
            btn.style.backgroundColor = "#ccc";
            btn.onclick = () => liff.closeWindow();
        }

        // å•Ÿå‹•
        main();

    </script>
</body>
</html>
